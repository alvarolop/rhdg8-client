= HotRod tester
Álvaro López Medina <alopezme@redhat.com>
v1.0, 2020-12
// Create TOC wherever needed
:toc: macro
:sectanchors:
:sectnumlevels: 2
:sectnums:
:source-highlighter: pygments
:imagesdir: images
// Start: Enable admonition icons
ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
endif::[]
ifndef::env-github[]
:icons: font
endif::[]
// End: Enable admonition icons
// Create the Table of contents here
toc::[]


This project is based on the work of @drhelius at https://github.com/drhelius/hotrod-tester

== Create the OCP application



[%header,cols=3*]
.Environment variables
|===
| Variable name
| Definition
| Example

| DATAGRID_HOST
| Host where the RHDG server is listening
| rhdg73-4-server

| DATAGRID_PORT
| Port where the RHDG server is listening
| 11222
|===



[source, bash]
----
## Configuration
export app_name=<app_name>
export namespace=<namespace>
export git_repo=<git_repo>
export context_dir=<context_dir>
export server_name=<server_application_name>

## Create application from template
oc process -f ocp-template.yml -p APPLICATION_NAME=$app_name -p GIT_REPOSITORY=$git_repo -p GIT_CONTEXT_DIR=$context_dir | oc apply -n $namespace -f -

## Expose route
oc expose svc $app_name -n $namespace

## Create configmap
oc create configmap ${app_name}-file-config --from-file=./${context_dir}/src/main/resources/application.properties -n $namespace
oc create configmap ${app_name}-logback-config --from-file=./${context_dir}/src/main/resources/logback-spring.xml -n $namespace


## Start new build and deployment
oc start-build --follow $app_name -n $namespace
oc rollout latest $app_name -n $namespace


## Set environment variables
oc set env dc $app_name DATAGRID_HOST=${server_name} DATAGRID_PORT=11222 -n $namespace
oc set env dc $app_name --list
----


## 2. Alternative usage

[source, bash]
----
oc new-app --name hotrod-tester openshift/redhat-openjdk18-openshift:1.8    ~https://github.com/drhelius/hotrod-tester.git
----


## 3. Usage

Set your cluster url:
[source, bash]
----
# These variables were already settled:
export app_name=<app_name>
export namespace=<namespace>

# These are new:
export cluster_url=<cluster_url>
export cache_name=default
----

[source, bash]
----
curl "http://${app_name}-${namespace}.${cluster_url}/api/cache/${cache_name}/put/?entries=100000&minkey=0"
----

Usage examples:
[source, bash]
----
# PUT ASYNC
curl "http://${app_name}-${namespace}.${cluster_url}/api/cache/${cache_name}/put/?entries=100000&minkey=0&async=true"
curl "http://${app_name}-${namespace}.${cluster_url}/api/cache/${cache_name}/put/?entries=100000&minkey=100000&async=true"
curl "http://${app_name}-${namespace}.${cluster_url}/api/cache/${cache_name}/put/?entries=100000&minkey=200000&async=true"

# GET ASYNC
curl "http://${app_name}-${namespace}.${cluster_url}/api/cache/${cache_name}/get/?entries=100000&minkey=0&async=true"

# PUT SYNC
curl "http://${app_name}-${namespace}.${cluster_url}/api/cache/${cache_name}/put/?entries=100000&minkey=0"
curl "http://${app_name}-${namespace}.${cluster_url}/api/cache/${cache_name}/put/?entries=100000&minkey=100000"
curl "http://${app_name}-${namespace}.${cluster_url}/api/cache/${cache_name}/put/?entries=100000&minkey=200000"
curl "http://${app_name}-${namespace}.${cluster_url}/api/cache/${cache_name}/put/?entries=100000&minkey=300000"

# Test 10 entries
curl "http://${app_name}-${namespace}.${cluster_url}/api/cache/${cache_name}/put/?entries=10&minkey=0"

# Obtain stats
curl "http://${app_name}-${namespace}.${cluster_url}/api/cache/${cache_name}/stats"

# Get value of 1 entry
curl "http://${app_name}-${namespace}.${cluster_url}/api/cache/${cache_name}/get-single?key=0"
----




## 4. Testing RHDG images

Follow these steps:


[source, bash]
----
# Fill the cache with 30k entries
curl -G "http://${app_name}-${namespace}.${cluster_url}/api/cache/default/put-simple" -d entries=30000 -d minkey=0 -d entrycontent=Test


# Retrieve some of the values
for ((i=1;i<=100;i++)); do echo "===> ENTRY $((i))"; curl -G "http://${app_name}-${namespace}.${cluster_url}/api/cache/default/get-single-string" -d key=$((i)); done


# Fill another cache with big key-values of type byte
curl -G "http://${app_name}-${namespace}.${cluster_url}/api/cache/default/put" -d entries=30000 -d minkey=40000 -d async=false -d size=10


# Retrieve some of the values
for ((i=1;i<=100;i++)); do echo "===> ENTRY $((40000+i))"; curl -G "http://${app_name}-${namespace}.${cluster_url}/api/cache/default/get-single" -d key=$((40000+i)); done


# Perform many requests in parallel
for ((i=1;i<=10;i++)); do curl -G "http://${app_name}-${namespace}.${cluster_url}/api/cache/default/get" -d entries=1000 -d minkey=40000 -d async=true; done
----


## 5. Debugging inside the pod

It is possible to enter into a pod and execute commands to check cache cluster stats:


[source, bash]
----
# Enter into the pod
$ oc rsh rhdg73-4-server-0

# Use the cli command line
$ /opt/datagrid/bin/cli.sh -c

# Check attributes of a cache
/subsystem=datagrid-infinispan/cache-container=clustered/distributed-cache=default:read-resource(include-runtime=true)
----


